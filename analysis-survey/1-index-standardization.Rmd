---
title: "Spatiotemporal models of `r paste(params$species)` biomass with RW"
author: "Philina English"
date: "`r Sys.Date()`"
output: html_document
params:
    # species: "Redbanded Rockfish"
    # species: "Arrowtooth Flounder"
    # species: "North Pacific Spiny Dogfish"
    # species: "Pacific Ocean Perch"
    species: "Bocaccio"
    # species: "Yelloweye Rockfish"
    # species: "Pacific Sand Lance"
    # species: "Pacific Herring"
    # region: "Coast-wide trawl surveys"
    region: "HBLL outside surveys"
    name: "-rw-no-covs" # covariate string used to name model rds
    update_model: FALSE # TRUE will over write past models; will alway attempt a model if none exists
    update_index: TRUE
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(
  fig.width = 11, fig.height = 8.5,
  # fig.path=paste0("figs/", spp, "/"),
  echo = FALSE, warning = FALSE, message = FALSE
)
library(dplyr)
library(ggplot2)
library(gfplot)
library(gfdata)
library(sdmTMB)

# options(scipen = 999)
theme_set(
  gfplot::theme_pbs(base_size = 14)
)

# clean up environment just in case
rm(m)
rm(p)
rm(i)
```

```{r params}
species <- params$species
region <- params$region
name <- params$name
update_model <- params$update_model
update_index <- params$update_index

paste("region =", region)
paste("model label =", name)
```
Load data
```{r, message=FALSE, warning=FALSE}
spp <- gsub(" ", "-", gsub("\\/", "-", tolower(species)))
all_data <- readRDS(paste0("~/github/dfo/gfsynopsis/report/data-cache/", spp, ".rds"))

if (region == "Both odd year trawl surveys") {
  nd_all <- readRDS(paste0("data/nd_whole_coast_index.rds")) %>% mutate(area = 4)
  survey <- c("SYN QCS", "SYN HS")
  type <- "trawl"
  model_ssid <- c(1, 3)
}

if (region == "QCS only") {
  nd_all <- readRDS(paste0("data/nd_whole_coast_index.rds")) %>% mutate(area = 4)
  survey <- c("SYN QCS")
  type <- "trawl"
  model_ssid <- c(1)
}

if (region == "HS only") {
  nd_all <- readRDS(paste0("data/nd_whole_coast_index.rds")) %>% mutate(area = 4)
  survey <- c("SYN HS")
  type <- "trawl"
  model_ssid <- c(3)
}

if (region == "WCVI only") {
  nd_all <- readRDS(paste0("data/nd_whole_coast_index.rds")) %>% mutate(area = 4)
  survey <- c("SYN WCVI")
  type <- "trawl"
  model_ssid <- c(4)
}

if (region == "WCHG only") {
  nd_all <- readRDS(paste0("data/nd_whole_coast_index.rds")) %>% mutate(area = 4)
  survey <- c("SYN WCHG")
  type <- "trawl"
  model_ssid <- c(16)
}

if (region == "Coast-wide trawl surveys") {
  nd_all <- readRDS(paste0("data/nd_whole_coast_index.rds")) %>% mutate(area = 4)
  survey <- c("SYN QCS", "SYN HS", "SYN WCVI", "SYN WCHG")
  type <- "trawl"
  model_ssid <- c(1, 3, 4, 16)
}

if (region == "North (PMFC 5DE)") {
  nd_all <- readRDS(paste0("data/nd_whole_coast_index.rds")) %>% mutate(area = 4)
  nd_5D <- filter(nd_all, survey == "SYN HS") %>% filter(Y > 5907.814)
  nd_5E <- filter(nd_all, survey == "SYN WCHG") 
  nd_all <- bind_rows(nd_5D, nd_5E)
  survey <- c("SYN HS", "SYN WCHG")
  type <- "trawl"
  model_ssid <- c(3, 16)
}

if (region == "South (PMFC 3CD5ABC)") {
  nd_all <- readRDS(paste0("data/nd_whole_coast_index.rds")) %>% mutate(area = 4)
  nd_5C <- filter(nd_all, survey == "SYN HS") %>% filter(Y < 5907.814)
  nd_south <- filter(nd_all, survey %in% c("SYN QCS", "SYN WCVI")) 
  nd_all <- bind_rows(nd_5C, nd_south)
  survey <- c("SYN HS", "SYN QCS", "SYN WCVI")
  type <- "trawl"
  model_ssid <- c(1, 3, 4)
}

if (region == "South 5 only (PMFC 5ABC)") {
  nd_all <- readRDS(paste0("data/nd_whole_coast_index.rds")) %>% mutate(area = 4)
  nd_5C <- filter(nd_all, survey == "SYN HS") %>% filter(Y < 5907.814)
  nd_QCS <- filter(nd_all, survey %in% c("SYN QCS")) 
  nd_all <- bind_rows(nd_5C, nd_QCS)
  survey <- c("SYN HS", "SYN QCS")
  type <- "trawl"
  model_ssid <- c(1, 3)
}

if (region == "HS & WCHG") {
  nd_all <- readRDS(paste0("data/nd_whole_coast_index.rds")) %>% mutate(area = 4)
  survey <- c("SYN HS", "SYN WCHG")
  type <- "trawl"
  model_ssid <- c(3, 16)
}

if (region == "QCS & WCVI") {
  nd_all <- readRDS(paste0("data/nd_whole_coast_index.rds")) %>% mutate(area = 4)
  survey <- c("SYN QCS", "SYN WCVI")
  type <- "trawl"
  model_ssid <- c(1, 4)
}

if (region == "HBLL outside surveys") {
  nd_all <- readRDS(paste0("data/nd_hbll_outside_index.rds")) %>% mutate(area = 4)
  survey <- c("HBLL OUT N", "HBLL OUT S")
  type <- "hbll"
  model_ssid <- c(22, 36)
}

if (region == "HBLL inside surveys") {
  # need a grid for HBLL outside
  # nd_all <- readRDS(paste0("data/nd_hbll_inside_index.rds")) %>% mutate(area = 4)
  survey <- c("HBLL IN N", "HBLL IN S")
  type <- "hbll"
  model_ssid <- c(39, 40)
}


```


Filter data 
```{r}
if (type == "trawl"){
  d <- all_data$survey_sets %>%
  filter(survey_abbrev %in% survey) 
  units <- "density_kgpm2"  
  d$density <- d[[units]] * 1000000 # change from per m2 to per km2
  family <- tweedie(link = 'log')
} else {
  d <- all_data$survey_sets %>%
  filter(survey_abbrev %in% survey) 
  units <- "density_ppkm2"
  d$density <- d[[units]] # change from per m2 to per km2
  family <- tweedie(link = 'log')
  # family <- nbinom2(link = 'log') # could use this instead, but would need to change units and add offset
}

if (region == "North (PMFC 5DE)") {
  d <- d %>% filter(survey_abbrev == "SYN WCHG" | latitude > 53.3)
}

if (region == "South (PMFC 3CD5ABC)") {
  d <- d %>% filter(survey_abbrev != "SYN WCHG" & latitude < 53.3)
}

if (region == "South 5 only (PMFC 5ABC)") {
  d <- d %>% filter(survey_abbrev %in% c("SYN QCS", "SYN HS") & latitude < 53.3)
}  
  
positive_sets <- filter(d, density != 0)
prop_pos <- round(nrow(positive_sets) / nrow(d), digits = 3)
data <- d %>% filter(survey_abbrev %in% unique(positive_sets$survey_abbrev))
ssid_string <- paste0( unique(data$survey_series_id.x), collapse = "n")
surv_string <- paste0( unique(data$survey_abbrev), collapse = ", ")
data <- sdmTMB::add_utm_columns(data, c("longitude", "latitude"))
```


```{r}
# Check if a model already exists
try({
  m <- readRDS(paste0("models/m-", spp, "-", ssid_string, name, ".rds"))
})
if (!exists("m")) update_model <- TRUE
```

Make mesh
```{r}
if (prop_pos < 0.1) {
  spde <- make_mesh(data, xy_cols = c("X", "Y"), cutoff = 25)
  plot(spde)
} else {
  if (prop_pos < 0.7) {
    spde <- make_mesh(data, xy_cols = c("X", "Y"), cutoff = 10)
    plot(spde)
  } else {
    spde <- make_mesh(data, xy_cols = c("X", "Y"), cutoff = 15)
    plot(spde)
  }
}
```

Run sdmTMB model

```{r}
if (update_model) {
  tictoc::tic()
  m <- sdmTMB(
    density ~ 1,
    data,
    mesh = spde,
    time = "year",
    family = family,
    spatial = "on",
    spatiotemporal = "RW",
    # reml = TRUE,
    silent = TRUE
  )

  saveRDS(m, file = paste0("models/m-", spp, "-", ssid_string, name, ".rds"))
  tictoc::toc()
}
```

```{r}
try({
  m <- readRDS(paste0("models/m-", spp, "-", ssid_string, name, ".rds"))
})
if (max(m$gradients) > 0.001) {
  m <- run_extra_optimization(m)
  saveRDS(m, file = paste0("models/m-", spp, "-", ssid_string, name, ".rds"))
}
if (exists("m")) {
  m
}
```

Check depths of positive sets
```{r}
hist(data$depth_m)
hist(positive_sets$depth_m)
depth_limit <- ifelse(
  max(positive_sets$depth_m, na.rm = T) > 500, max(positive_sets$depth_m, na.rm = T), max(positive_sets$depth_m, na.rm = T) + 100
  )
```

Get simulated index
```{r}
if (exists("m")) {
  if (max(m$gradients) < 0.001 & update_index) {
    nd <- nd_all %>%
      filter(survey %in% unique(positive_sets$survey_abbrev)) %>%
      filter(year %in% unique(m$data$year)) %>%
      filter(depth < depth_limit)
    nd <- na.omit(nd)
    nd$year <- as.integer(nd$year)
    # nd_sum <- nd %>% group_by(year) %>% summarise()
    # nd_sum <- melt(nd, measure.vars=c("year","survey"))

    samples <- data %>% 
      count(year, survey_abbrev) %>% 
      group_by(year) %>%
      mutate(freq = n / sum(n), total = sum(n)) %>% 
      filter(n == max(n)) %>% 
      select(year, dominant_surv = survey_abbrev, total, freq)
        

    p <- predict(m, newdata = nd, nsim = 200)
    # saveRDS(p, file = paste0("data/p-", spp, "-", ssid_string, name, ".rds"))

    i <- get_index_sims(p, area = nd$area) 
    i <- i %>% mutate(
      species = species,
      type = type, 
      region = region,
      surveys = paste(unique(positive_sets$survey_abbrev), collapse = ", "),
      ssids = paste(unique(positive_sets$survey_series_id.x), collapse = ", "),
      ssid_string = ssid_string, 
      max_grad = max(m$gradients)
      )
    i <- left_join(i, samples)
    saveRDS(i, paste0("indices/i-", spp, "-", ssid_string, name, ".rds"))
  }
  max(m$gradients)
}
```

```{r}
try({
  i <- readRDS(paste0("indices/i-", spp, "-", ssid_string, name, ".rds"))
})

if (exists("i")) {
  rm(g)
  g <- ggplot(i, aes(year, est / 1000)) +
    geom_line() +
    geom_ribbon(aes(ymin = lwr / 1000, ymax = upr / 1000), alpha = 0.4) +
    coord_cartesian(ylim = c(0, ifelse(
      max(i$upr) < 5 * max(i$est), max(i$upr) / 1000, max(i$est) * 3 / 1000
    ))) +
    ylab("Biomass (tonnes)") +
    ggtitle(paste(species), subtitle = paste0(region, " (", surv_string, ")"))
  ggsave(paste0("figs/", spp, "-", ssid_string, name, ".png"), height = 4, width = 6)
  g
}
```
